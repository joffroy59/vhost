/*! Fabrik */
AdvancedSearch=new Class({Implements:[Options,Events],options:{ajax:!1,controller:"list",parentView:"",defaultStatement:"="},initialize:function(a){this.setOptions(a),this.form=document.id("advanced-search-win"+this.options.listref).getElement("form"),this.trs=Array.from([]),this.form.getElement(".advanced-search-add")&&(this.form.getElement(".advanced-search-add").removeEvents("click"),this.form.getElement(".advanced-search-add").addEvent("click",function(a){this.addRow(a)}.bind(this)),this.form.getElement(".advanced-search-clearall").removeEvents("click"),this.form.getElement(".advanced-search-clearall").addEvent("click",function(a){this.resetForm(a)}.bind(this)),this.trs.each(function(a){a.inject(this.form.getElement(".advanced-search-list").getElements("tr").getLast(),"after")}.bind(this))),this.form.addEvent("click:relay(tr)",function(a,b){this.form.getElements("tr").removeClass("fabrikRowClick"),b.addClass("fabrikRowClick")}.bind(this)),this.watchDelete(),this.watchApply(),this.watchElementList(),Fabrik.fireEvent("fabrik.advancedSearch.ready",this)},watchApply:function(){this.form.getElement(".advanced-search-apply").addEvent("click",function(a){Fabrik.fireEvent("fabrik.advancedSearch.submit",this);var b=Fabrik["filter_"+this.options.parentView];"null"!==typeOf(b)&&b.onSubmit();var c=this.getList();new Element("input",{name:"resetfilters",value:1,type:"hidden"}).inject(this.form),this.options.ajax&&(a.stop(),c.submit(this.options.controller+".filter"))}.bind(this))},getList:function(){var a=Fabrik.blocks["list_"+this.options.listref];return"null"===typeOf(a)&&(a=Fabrik.blocks[this.options.parentView]),a},watchDelete:function(){this.form.getElements(".advanced-search-remove-row").removeEvents(),this.form.getElements(".advanced-search-remove-row").addEvent("click",function(a){this.removeRow(a)}.bind(this))},watchElementList:function(){this.form.getElements("select.key").removeEvents(),this.form.getElements("select.key").addEvent("change",function(a){this.updateValueInput(a)}.bind(this))},updateValueInput:function(a){var b=a.target.getParent("tr");Fabrik.loader.start(b);var c=a.target.get("value"),d=a.target.getParent().getParent().getElements("td")[3];if(""===c)return void d.set("html","");var e="index.php?option=com_fabrik&task=list.elementFilter&format=raw",f=this.options.elementMap[c];new Request.HTML({url:e,update:d,data:{element:c,id:this.options.listid,elid:f.id,plugin:f.plugin,counter:this.options.counter,listref:this.options.listref,context:this.options.controller,parentView:this.options.parentView},onComplete:function(){Fabrik.loader.stop(b)}}).send()},addRow:function(a){this.options.counter++,a.stop();var b=this.form.getElement(".advanced-search-list").getElement("tbody").getElements("tr").getLast(),c=b.clone();c.removeClass("oddRow1").removeClass("oddRow0").addClass("oddRow"+this.options.counter%2),c.inject(b,"after"),c.getElement("td").empty().set("html",this.options.conditionList);var d=c.getElements("td");d[1].empty().set("html",this.options.elementList),d[1].adopt([new Element("input",{type:"hidden",name:"fabrik___filter[list_"+this.options.listref+"][search_type][]",value:"advanced"}),new Element("input",{type:"hidden",name:"fabrik___filter[list_"+this.options.listref+"][grouped_to_previous][]",value:"0"})]),d[2].empty().set("html",this.options.statementList),d[3].empty(),this.watchDelete(),this.watchElementList(),Fabrik.fireEvent("fabrik.advancedSearch.row.added",this)},removeRow:function(a){if(a.stop(),this.form.getElements(".advanced-search-remove-row").length>1){this.options.counter--;var b=a.target.findUp("tr"),c=new Fx.Morph(b,{duration:800,transition:Fx.Transitions.Quart.easeOut,onComplete:function(){b.dispose()}});c.start({height:0,opacity:0})}Fabrik.fireEvent("fabrik.advancedSearch.row.removed",this)},resetForm:function(){var a=this.form.getElement(".advanced-search-list");a&&(a.getElements("tbody tr").each(function(a,b){b>=1&&a.dispose(),0===b&&(a.getElements(".inputbox").each(function(a){a.id.test(/condition$/)?a.value=this.options.defaultStatement:a.selectedIndex=0}.bind(this)),a.getElements("input").each(function(a){a.value=""}))}.bind(this)),this.watchDelete(),this.watchElementList(),Fabrik.fireEvent("fabrik.advancedSearch.reset",this))},deleteFilterOption:function(a){event.target.removeEvent("click",function(a){this.deleteFilterOption(a)}.bind(this));var b=event.target.parentNode.parentNode,c=b.parentNode;c.removeChild(b),a.stop()}});